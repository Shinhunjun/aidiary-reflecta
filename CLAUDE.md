# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Git Commit Guidelines

**IMPORTANT**: When creating git commits:
- DO NOT mention "Claude", "Claude Code", or any AI tool names in commit messages
- DO NOT add "Generated with Claude Code" or "Co-Authored-By: Claude" attribution
- Keep commit messages professional and focused on the technical changes
- Use conventional commit format: type + brief description + detailed body

## Project Overview

Reflecta is an AI-powered personal reflection journal application with three distinct user roles (student, counselor, admin) that combines journaling, goal-setting using the Mandalart framework, and mental health risk detection. The application is split into a React frontend and Node.js/Express backend.

**Live URLs:**
- Frontend: https://aidiary-reflecta.vercel.app
- Backend: https://reflecta-backend-762303020827.us-central1.run.app

## Development Commands

### Frontend (reflecta-frontend)
```bash
cd reflecta-frontend
npm install           # Install dependencies
npm start            # Start dev server on http://localhost:3000
npm run build        # Create production build
npm test             # Run tests
```

### Backend (reflecta-backend)
```bash
cd reflecta-backend
npm install           # Install dependencies
npm start            # Start server on port 5000
npm run dev          # Start with nodemon for auto-reload
```

### Environment Setup
- Frontend requires `.env` file with `REACT_APP_API_URL`
- Backend requires `.env` file with `MONGODB_URI`, `JWT_SECRET`, `CORS_ORIGIN`, `OPENAI_API_KEY`, `OPENAI_API_URL`
- See `reflecta-backend/env.example` for backend environment variables template

## Architecture Overview

### Frontend Architecture
The frontend uses React with a Context-based state management pattern:

1. **Contexts** (`src/contexts/`):
   - `AuthContext.js`: Manages user authentication state, login/logout, and role-based access
   - `JournalContext.js`: Manages journal entries state and operations
   - `SidebarContext.js`: Controls sidebar visibility

2. **API Service Layer** (`src/services/api.js`):
   - Centralized API communication using `ApiService` class
   - Handles authentication token management
   - All backend requests go through this service

3. **Component Organization**:
   - Role-based routing with `ProtectedRoute` and `CounselorRoute` components in `App.js`
   - Student components: Dashboard, Journal, GoalSetting, ProgressTracking, Chat
   - Counselor components: CounselorDashboard (for monitoring student risk alerts)
   - Shared: Home, Navbar, Sidebar

4. **Key Frontend Features**:
   - **Mandalart Goal System**: Interactive 9x9 grid in `GoalSetting.js` (1 core goal → 8 sub-goals → 64 actionable tasks)
   - **Chat-to-Diary Conversion**: Users select chat messages and convert them to structured journal entries
   - **Privacy Settings**: Students control risk monitoring consent and counselor access
   - **Word Cloud Visualization**: In `WordCloud.js` with 7-day caching for journal insights

### Backend Architecture
The backend is a monolithic Express.js server (`server.js`) with embedded routes:

1. **Data Models** (`models/`):
   - `User.js`: Three roles (student/counselor/admin) with role-specific profiles and privacy settings
   - `Goal.js`: Nested Mandalart structure with `mandalartData` containing recursive `subGoals`
   - `JournalEntry.js`: Entries with mood tracking, goal mapping, and risk analysis results
   - `GoalProgress.js`: Time-series progress tracking for goals
   - `ChatSession.js`: Stores AI conversation history
   - `RiskAlert.js`: Mental health risk alerts generated by AI analysis
   - `GoalSummary.js`: Cached AI-generated summaries (7-day cache to reduce API costs)

2. **Services** (`services/`):
   - `riskDetectionService.js`: AI-powered mental health risk analysis using OpenAI
     - Analyzes journal entries for risk indicators
     - Requires user consent via `privacySettings.riskMonitoring.enabled`
     - Creates RiskAlert records for counselor review
     - Respects privacy levels: summary/moderate/detailed

3. **Middleware** (`middleware/`):
   - `authorization.js`: Role-based access control functions
     - `requireRole()`: Enforces role requirements
     - `canAccessStudent()`: Checks if counselor can access student data
     - `canModifyAlert()`: Validates alert modification permissions

4. **Key Backend Patterns**:
   - All routes are defined directly in `server.js` (monolithic structure)
   - JWT authentication with `authMiddleware` function
   - OpenAI integration for: chat responses, diary conversion, goal suggestions, risk analysis, and summaries
   - 7-day caching pattern for expensive AI operations (summaries, word clouds)

### Critical Data Flow: Chat-to-Diary Conversion
1. User selects messages in Chat component
2. Frontend calls `POST /api/convert-to-diary` with selected messages
3. Backend uses OpenAI to generate structured diary entry
4. Backend calls `POST /api/analyze-goal-mapping` to map entry to existing goals
5. If risk monitoring enabled, triggers `riskDetectionService.analyzeJournalEntry()`
6. Returns diary entry with goal mappings and risk analysis

### Role-Based Access Control
- Students can only access their own data
- Counselors can access student data ONLY if:
  - Student has enabled `privacySettings.riskMonitoring.enabled`
  - Student has the counselor in `privacySettings.assignedCounselors` array
- Admin role exists but features not fully implemented

## Important Conventions

### Goal Structure (Mandalart)
The nested structure is: `mandalartData` (root) → `subGoals[8]` (level 1) → each has `subGoals[8]` (level 2, the 64 tasks)
- Always maintain this 3-level hierarchy when modifying goals
- Progress calculation aggregates completion status from all levels

### AI API Cost Optimization
- Summaries are cached for 7 days in `GoalSummary` collection
- Always check for existing cached summaries before calling OpenAI
- Pattern: Query by `userId`, `goalId`, and `createdAt > (now - 7 days)`

### Privacy-First Approach
Before accessing student data in counselor features:
1. Check `user.privacySettings.riskMonitoring.enabled === true`
2. Verify counselor is in `user.privacySettings.assignedCounselors`
3. Respect `shareLevel` when displaying data (summary/moderate/detailed)

### Authentication Flow
- Frontend stores JWT in localStorage via `apiService.setToken()`
- Frontend stores user object in localStorage as `currentUser`
- Backend validates JWT using `authMiddleware` on protected routes
- User object structure: `{ id, email, name, role }`

## Deployment Notes

### Frontend (Vercel)
- Deployed from `reflecta-frontend` directory
- Environment variables must be set in Vercel dashboard with `REACT_APP_` prefix
- Uses Create React App build process

### Backend (Google Cloud Run)
- Containerized deployment using `Dockerfile` in `reflecta-backend`
- Deploy with: `gcloud run deploy reflecta-backend --source . --region us-central1 --allow-unauthenticated --env-vars-file .env.yaml --port 5000`
- Environment variables stored in `.env.yaml` (not committed to git)
- CORS configured to allow both Vercel production URL and localhost

## Utility Scripts

Located in `reflecta-backend/`:
- `seedTestData.js`: Populates database with sample data for testing
- `seedJournalsForSubGoals.js`: Creates journal entries mapped to specific sub-goals
- `checkGoalMapping.js`: Verifies goal-journal mapping integrity
- `resetPassword.js`: Admin utility to reset user passwords

## Testing Considerations

- Frontend uses Jest and React Testing Library (`npm test` in reflecta-frontend)
- Backend has no tests currently (test script returns error)
- When adding features, consider privacy settings impact on counselor access
- Test with different user roles (student/counselor) to verify authorization

## Common Tasks

### Adding a new API endpoint
1. Add route handler directly in `reflecta-backend/server.js`
2. Use `authMiddleware` for protected routes
3. Add corresponding method in `reflecta-frontend/src/services/api.js`
4. Update frontend component to call the new API method

### Adding a new data model
1. Create schema in `reflecta-backend/models/`
2. Import in `server.js`
3. Add indexes for frequently queried fields
4. Consider privacy implications if student data

### Modifying goal structure
- Always test with the full 3-level Mandalart hierarchy
- Update progress calculation logic if changing completion tracking
- Verify that GoalSetting.js UI handles the changes correctly
