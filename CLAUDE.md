# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Git Commit Guidelines

**IMPORTANT**: When creating git commits:
- DO NOT mention "Claude", "Claude Code", or any AI tool names in commit messages
- DO NOT add "Generated with Claude Code" or "Co-Authored-By: Claude" attribution
- Keep commit messages professional and focused on the technical changes
- Use conventional commit format: type + brief description + detailed body

## Project Overview

Reflecta is an AI-powered personal reflection journal application with three distinct user roles (student, counselor, admin) that combines journaling, goal-setting using the Mandalart framework, and mental health risk detection. The application is split into a React frontend and Node.js/Express backend.

**Live URLs:**
- Frontend: https://aidiary-reflecta.vercel.app
- Backend: https://reflecta-backend-762303020827.us-central1.run.app

## Development Commands

### Frontend (reflecta-frontend)
```bash
cd reflecta-frontend
npm install           # Install dependencies
npm start            # Start dev server on http://localhost:3000
npm run build        # Create production build
npm test             # Run tests
```

### Backend (reflecta-backend)
```bash
cd reflecta-backend
npm install           # Install dependencies
npm start            # Start server on port 5000
npm run dev          # Start with nodemon for auto-reload
```

### Environment Setup
- Frontend requires `.env` file with `REACT_APP_API_URL`
- Backend requires `.env` file with `MONGODB_URI`, `JWT_SECRET`, `CORS_ORIGIN`, `OPENAI_API_KEY`, `OPENAI_API_URL`
- See `reflecta-backend/env.example` for backend environment variables template

## Architecture Overview

### Frontend Architecture
The frontend uses React with a Context-based state management pattern:

1. **Contexts** (`src/contexts/`):
   - `AuthContext.js`: Manages user authentication state, login/logout, and role-based access
   - `JournalContext.js`: Manages journal entries state and operations
   - `SidebarContext.js`: Controls sidebar visibility

2. **API Service Layer** (`src/services/api.js`):
   - Centralized API communication using `ApiService` class
   - Handles authentication token management
   - All backend requests go through this service

3. **Component Organization**:
   - Role-based routing with `ProtectedRoute` and `CounselorRoute` components in `App.js`
   - Student components: Dashboard, Journal, GoalSetting, ProgressTracking, Chat
   - Counselor components: CounselorDashboard (for monitoring student risk alerts)
   - Shared: Home, Navbar, Sidebar

4. **Key Frontend Features**:
   - **Mandalart Goal System**: Interactive 9x9 grid in `GoalSetting.js` (1 core goal â†’ 8 sub-goals â†’ 64 actionable tasks)
   - **Chat-to-Diary Conversion**: Users select chat messages and convert them to structured journal entries
   - **Privacy Settings**: Students control risk monitoring consent and counselor access
   - **Word Cloud Visualization**: In `WordCloud.js` with 7-day caching for journal insights

### Backend Architecture
The backend is a monolithic Express.js server (`server.js`) with embedded routes:

1. **Data Models** (`models/`):
   - `User.js`: Three roles (student/counselor/admin) with role-specific profiles and privacy settings
   - `Goal.js`: Nested Mandalart structure with `mandalartData` containing recursive `subGoals`
   - `JournalEntry.js`: Entries with mood tracking, goal mapping, and risk analysis results
   - `GoalProgress.js`: Time-series progress tracking for goals
   - `ChatSession.js`: Stores AI conversation history
   - `RiskAlert.js`: Mental health risk alerts generated by AI analysis
   - `GoalSummary.js`: Cached AI-generated summaries (7-day cache to reduce API costs)

2. **Services** (`services/`):
   - `riskDetectionService.js`: AI-powered mental health risk analysis using OpenAI
     - Analyzes journal entries for risk indicators
     - Requires user consent via `privacySettings.riskMonitoring.enabled`
     - Creates RiskAlert records for counselor review
     - Respects privacy levels: summary/moderate/detailed

3. **Middleware** (`middleware/`):
   - `authorization.js`: Role-based access control functions
     - `requireRole()`: Enforces role requirements
     - `canAccessStudent()`: Checks if counselor can access student data
     - `canModifyAlert()`: Validates alert modification permissions

4. **Key Backend Patterns**:
   - All routes are defined directly in `server.js` (monolithic structure)
   - JWT authentication with `authMiddleware` function
   - OpenAI integration for: chat responses, diary conversion, goal suggestions, risk analysis, and summaries
   - 7-day caching pattern for expensive AI operations (summaries, word clouds)

### Critical Data Flow: Chat-to-Diary Conversion
1. User selects messages in Chat component
2. Frontend calls `POST /api/convert-to-diary` with selected messages
3. Backend uses OpenAI to generate structured diary entry
4. Backend calls `POST /api/analyze-goal-mapping` to map entry to existing goals
5. If risk monitoring enabled, triggers `riskDetectionService.analyzeJournalEntry()`
6. Returns diary entry with goal mappings and risk analysis

### Role-Based Access Control
- Students can only access their own data
- Counselors can access student data ONLY if:
  - Student has enabled `privacySettings.riskMonitoring.enabled`
  - Student has the counselor in `privacySettings.assignedCounselors` array
- Admin role exists but features not fully implemented

## Important Conventions

### Goal Structure (Mandalart)
The nested structure is: `mandalartData` (root) â†’ `subGoals[8]` (level 1) â†’ each has `subGoals[8]` (level 2, the 64 tasks)
- Always maintain this 3-level hierarchy when modifying goals
- Progress calculation aggregates completion status from all levels

### AI API Cost Optimization
- Summaries are cached for 7 days in `GoalSummary` collection
- Always check for existing cached summaries before calling OpenAI
- Pattern: Query by `userId`, `goalId`, and `createdAt > (now - 7 days)`

### Privacy-First Approach
Before accessing student data in counselor features:
1. Check `user.privacySettings.riskMonitoring.enabled === true`
2. Verify counselor is in `user.privacySettings.assignedCounselors`
3. Respect `shareLevel` when displaying data (summary/moderate/detailed)

### Authentication Flow
- Frontend stores JWT in localStorage via `apiService.setToken()`
- Frontend stores user object in localStorage as `currentUser`
- Backend validates JWT using `authMiddleware` on protected routes
- User object structure: `{ id, email, name, role }`

## Deployment Notes

### Frontend (Vercel)
- Deployed from `reflecta-frontend` directory
- Environment variables must be set in Vercel dashboard with `REACT_APP_` prefix
- Uses Create React App build process

### Backend (Google Cloud Run)
- Containerized deployment using `Dockerfile` in `reflecta-backend`
- Deploy with: `gcloud run deploy reflecta-backend --source . --region us-central1 --allow-unauthenticated --env-vars-file .env.yaml --port 5000`
- Environment variables stored in `.env.yaml` (not committed to git)
- CORS configured to allow both Vercel production URL and localhost

## Utility Scripts

Located in `reflecta-backend/`:
- `seedTestData.js`: Populates database with sample data for testing
- `seedJournalsForSubGoals.js`: Creates journal entries mapped to specific sub-goals
- `checkGoalMapping.js`: Verifies goal-journal mapping integrity
- `resetPassword.js`: Admin utility to reset user passwords

## Testing Considerations

- Frontend uses Jest and React Testing Library (`npm test` in reflecta-frontend)
- Backend has no tests currently (test script returns error)
- When adding features, consider privacy settings impact on counselor access
- Test with different user roles (student/counselor) to verify authorization

## Common Tasks

### Adding a new API endpoint
1. Add route handler directly in `reflecta-backend/server.js`
2. Use `authMiddleware` for protected routes
3. Add corresponding method in `reflecta-frontend/src/services/api.js`
4. Update frontend component to call the new API method

### Adding a new data model
1. Create schema in `reflecta-backend/models/`
2. Import in `server.js`
3. Add indexes for frequently queried fields
4. Consider privacy implications if student data

### Modifying goal structure
- Always test with the full 3-level Mandalart hierarchy
- Update progress calculation logic if changing completion tracking
- Verify that GoalSetting.js UI handles the changes correctly

## Demo Landing Page (DemoLanding.js)

### Purpose
The Demo Landing Page serves as the primary marketing page for the LIKELION US 'AI Agents' Ideathon submission. It showcases Reflecta's value proposition, features, business model, and roadmap to potential investors, judges, and users.

### Component Structure

Located at `reflecta-frontend/src/components/DemoLanding.js` with styles in `DemoLanding.css`.

#### Key Sections (in order):
1. **Hero Section**: Main value proposition and CTA
2. **Problem Statement**: "The Journaling Dilemma" - addresses pain points
3. **Why Reflecta?**: Core differentiators and unique selling points
4. **User Storyboard** (4 scenes):
   - Scene 1: New User (pain point: giving up on traditional journaling)
   - Scene 2: Set Goals (Mandalart framework visualization)
   - Scene 3: Chat-to-Diary (conversational journaling)
   - Scene 4: Auto Diary (conversion with emoji: ðŸ’¬ â†’ ðŸ“”)
5. **How It Works**: Step-by-step user flow
6. **Business Model & Market**:
   - Monetization Model (pricing tiers with ad-supported free tier)
   - Go-to-Market Channels (2x2 grid layout)
   - TAM/SAM/SOM projections
7. **Technical Innovation**: OpenAI integration details
8. **Competitive Analysis**: Comparison table
9. **Roadmap**: 4-quarter timeline (Q1 2025 - Q2 2026)
10. **Team**: Founder information
11. **Final CTA**: Guided tour button with animations

### Important Patterns

#### Storyboard Content Guidelines
- **Scene 1** must emphasize the core pain point: Traditional journaling feels like a chore and leads to abandonment
- **Scene 4** should visually show transformation using arrow notation (ðŸ’¬ â†’ ðŸ“”) to illustrate chat-to-diary conversion
- Keep storyboard text concise and relatable to target demographic (students, young professionals)

#### Monetization Model Structure
```javascript
// Three-tier model with ad-supported free tier
Free Tier: $0
  - Ad-supported (non-intrusive sidebar ads)
  - Basic features with limitations

Premium Tier: $9.99/mo
  - Ad-free experience (first benefit listed)
  - All advanced features

Enterprise Tier: Custom pricing
  - Ad-free for all users
  - Counselor features and admin controls
```

**Why this matters**: Ad-supported free tier creates revenue stream while lowering barrier to entry. Always list "ad-free" as the first premium benefit to justify price point.

#### Roadmap Consolidation Strategy
- Keep timeline realistic and near-term focused (4 quarters max)
- Consolidate advanced features into Q1 to demonstrate technical capability
- Q1 2025 should be highlighted with `demo-roadmap-highlight` class
- Avoid distant future promises (Q3-Q4 2026+) that appear speculative

Example structure:
```
Q1 2025: ðŸš€ Beta Launch & AI Features (highlighted)
Q2 2025: Revenue & Growth
Q3 2025: Expand Features
Q4 2025 - Q2 2026: Scale & Expand
```

#### CTA Button Optimization

**Location**: Final section before footer, after all content

**Key Elements**:
1. **Subtitle with time commitment**: "âœ¨ Try our interactive demo â€” see it in action in just 3 minutes"
2. **Benefit-driven button text**: "Try Interactive Demo (3 min)" instead of generic "Start Tour"
3. **Animated rocket icon**: `<span className="demo-cta-icon">ðŸš€</span>` with bounce animation
4. **Button pulse animation**: Continuous attention-grabbing pulse effect

**CSS Implementation**:
```css
/* Pulse effect - runs continuously */
.demo-cta-pulse {
  animation: ctaPulse 2s ease-in-out infinite;
}

@keyframes ctaPulse {
  0%, 100% {
    box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4);
    transform: translateY(0);
  }
  50% {
    box-shadow: 0 12px 48px rgba(99, 102, 241, 0.6),
                0 0 0 8px rgba(99, 102, 241, 0.1);
    transform: translateY(-2px);
  }
}

/* Stop animation on hover for better UX */
.demo-cta-pulse:hover {
  animation: none;
  box-shadow: 0 16px 64px rgba(99, 102, 241, 0.5) !important;
  transform: translateY(-4px) scale(1.02) !important;
}

/* Icon bounce - independent animation */
.demo-cta-icon {
  animation: iconBounce 1s ease-in-out infinite;
}

@keyframes iconBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-3px); }
}
```

**CTA Best Practices**:
- Always include specific time commitment ("3 min") to reduce uncertainty
- Use action-oriented verbs ("Try" has lower friction than "Start")
- Add subtle animations that pause on hover (prevents annoyance)
- Include value proposition in subtitle before button
- Make mobile-responsive with adjusted font sizes

#### Grid Layout Conventions

**Go-to-Market Channels Section**: Uses explicit 2x2 grid instead of auto-fit

```css
.demo-marketing-channels {
  display: grid;
  grid-template-columns: repeat(2, 1fr);  /* Explicit 2 columns */
  gap: 25px;
}
```

**Why not auto-fit?**: `repeat(auto-fit, minmax(280px, 1fr))` can create inconsistent layouts on different screen sizes. For marketing content that must look professional on all devices, explicit column counts provide better control.

**When to use each**:
- `repeat(2, 1fr)`: Marketing content, comparison tables, feature grids with exact layout requirements
- `repeat(auto-fit, minmax())`: Dynamic content lists where item count varies

#### Animation Guidelines

**Framer Motion Integration**: All major sections use `initial="hidden" animate="visible" variants={containerVariants}`

**Standard animation variants**:
```javascript
const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: { staggerChildren: 0.2 }
  }
};

const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: { duration: 0.6, ease: "easeOut" }
  }
};
```

**Use animations sparingly**: Only for initial page load, scroll-triggered reveals, and primary CTAs. Avoid constant animations that distract from content.

### Tour Integration

Demo Landing Page includes `PageTour` component for guided walkthrough:

```javascript
<PageTour
  page="demo"
  steps={demoSteps}
  onComplete={() => {
    localStorage.setItem('demo_tour_completed', 'true');
    navigate('/goal-setting');
  }}
  navigateToNext="goal-setting"
  pageTotalSteps={6}
  pageStartStep={0}
/>
```

**Tour Context Integration**: Uses `TourContext` to coordinate multi-page tours. See [PageTour.js](reflecta-frontend/src/components/PageTour.js:1) for implementation details.

### Responsive Design

**Breakpoints**:
- Desktop: Default styles
- Tablet: `@media (max-width: 1024px)`
- Mobile: `@media (max-width: 768px)`

**Mobile-specific adjustments**:
- Hero font sizes: h2 from 48px â†’ 36px
- Feature grids: 3 columns â†’ 1 column
- Pricing cards: Side-by-side â†’ stacked
- CTA subtitle: 18px â†’ 16px
- Marketing channels: 2x2 grid â†’ 1 column

### Common Modifications

**Updating Storyboard Scenes**:
1. Locate scene in DemoLanding.js (around lines 490-550)
2. Update quote text to reflect user pain points
3. Update icon if showing transformation (use arrow notation: ðŸ’¬ â†’ ðŸ“”)
4. Keep descriptions under 2 sentences for readability

**Adding New Pricing Tier**:
1. Duplicate a `demo-pricing-card` div
2. Update badge, price, features list
3. Ensure "ad-free" benefit is listed first for paid tiers
4. Add tier to mobile responsive section if needed

**Modifying Roadmap**:
1. Keep total quarters to 4 or fewer
2. Use `demo-roadmap-highlight` class for current/next quarter
3. Group similar features under single milestone
4. Avoid distant dates (1+ years out) that seem speculative

**Changing CTA**:
1. Update both subtitle and button text together
2. Test time commitment accuracy ("3 min" should be realistic)
3. Verify animations work smoothly (pulse + icon bounce)
4. Check mobile responsiveness of new text length

### Ideathon-Specific Considerations

**Target Audience**: Judges and potential investors evaluating:
- Problem-solution fit
- Market opportunity size
- Technical feasibility
- Business model viability
- Team execution capability

**Content Priorities**:
1. Clear problem statement that resonates emotionally
2. Unique solution that's technically impressive but explained simply
3. Realistic roadmap showing near-term execution capability
4. Viable monetization model with multiple revenue streams
5. Compelling CTA that lets judges experience the product

**Avoid**:
- Overly technical jargon without context
- Unrealistic timelines (distant future features)
- Missing pain points (why users would switch from competitors)
- Generic value propositions without specificity
- Weak CTAs that don't invite interaction
